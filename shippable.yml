# Copyright 2018 Cyface GmbH
#
# This file is part of the Cyface KNIME Nodes.
#
# The Cyface KNIME Nodes is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# The Cyface KNIME Nodes is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with the Cyface KNIME Nodes. If not, see <http://www.gnu.org/licenses/>.

# Language setting
language: java

# Version number
jdk:
  - oraclejdk8

# Environment variables
env:
  - secure: BkbBqRptG7YLiHx0Q34lPyll6pGeeSOI5g1X6Ws9cjV4q9xJ3ItUbXggqofPo1r2KO9q5zv9IMWwU91w6fgPOx9G4Ufb4NlrkstE/+87xcSK/gRNdaruu2G8dgJZ3lK2nYzeh8oalYrgE8Rh9wOGwcdSXml3EavkW84j0PL8sOeh9gRjNwFYohSknw18f1CxnGkiIVco6QdVqbnUP6GCA8ltCk2TMakv7B2LGZkxEa3kCM7EUQxLwnuxF7qTyl6vNAFtuwaS3H1FnqcbfoJxFDcHyNxMq8sXSjeZ7A/x7CYLZHAv9PWc2/kbZ8/QGCXPKuOZ3CdOt1Rd1bC9iGwgfQ==

# Let Shippable inject the SSH key for nodepit.com
integrations:
  key:
    - integrationName: nodepit
      type: pemKey

# What are we doing here?
before_script:
  - mkdir -p de.cyface.knime/bin

build:
  cache: true
  cache_dir_list:
    - $HOME/.m2
  ci:
    # create display for workflow tests
    - apt-get update
    - apt-get install xvfb -y
    - Xvfb :12345 & export DISPLAY=:12345

    # maven build
    - mvn -V -B clean install

     # copy test and coverage results where shippable expects them
    - cp -r de.cyface.knime.tests/target/surefire-reports/. shippable/testresults/
    - cp -r de.cyface.knime.tests/target/site/jacoco/. shippable/codecoverage/
    - cp -r de.cyface.knime.tests/target/testflow-reports/. shippable/testresults/

    # only upload to nodepit.com when this is running on master branch
    - >
      if [ "$BRANCH" == "master" ] && [ "$IS_PULL_REQUEST" == false ]; then
        mkdir -p ~/.ssh &&
        echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config &&
        user_host=debian@nodepit.com &&
        label=3.5 &&
        download_directory=/home/debian/nodepit/download/files/cyface/$label &&
        download_zip=${download_directory}.zip &&
        ssh-agent bash -c "ssh-add /tmp/ssh/nodepit && ssh $user_host '[ -e $download_directory ] && rm -r $download_directory; mkdir -p $download_directory' && scp -rp de.cyface.knime.p2/target/repository/* $user_host:$download_directory" &&
        ssh-agent bash -c "ssh-add /tmp/ssh/nodepit && ssh $user_host '[ -e $download_zip ] && rm -r $download_zip'; scp -rp de.cyface.knime.p2/target/de.cyface.knime.p2-*.zip $user_host:$download_zip" &&
        ./update-product.sh https://nodepit.com/api/product/cyface $PRODUCT_EDIT_TOKEN CHANGELOG.md;
      fi;
  post_ci:
    # delete display
    - pkill -f "Xvfb :12345"
